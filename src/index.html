<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>AngularFormWithStepsV4</title>
		<meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
		<base href="/" />

		<!-- before deploying dont forget to change href  back, and while debugging set to "/" -->
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="icon" type="image/x-icon" href="favicon.ico" />
		<link
			href="https://fonts.googleapis.com/css?family=Roboto:300,400,500&display=swap"
			rel="stylesheet"
		/>
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
	</head>
	<body class="mat-typography">
		<script src="https://apis.google.com/js/api.js"></script>
		<div style="display: flex; justify-content: space-between">
			<!-- <button style="height: 50px; width: 120px" onclick="triggerDownloadAll()">
				TRIGGER ALL DOWNLOAD
			</button> -->
			<select
				style="height: 50px; width: 200px"
				name="project"
				id="project"
				onChange="handleProjectChange()"
			>
				<option value="youtube-mp3-downloader-392415" id="youtube-mp3-downloader-392415">
					youtube-mp3-downloader-392415
				</option>
				<option value="youtube-downloader-310313" id="youtube-downloader-310313">
					youtube-downloader-310313
				</option>
				<option value="youtube-mp3-downloader-3" id="youtube-mp3-downloader-3">
					youtube-mp3-downloader-3
				</option>
			</select>
			<select style="height: 50px; width: 120px" name="env" id="env" onChange="handleEnv()">
				<option value="local" id="local">local</option>
				<option value="github" id="github">github</option>
			</select>
			<select style="height: 50px; width: 200px" name="mode" id="mode" onChange="handleMode()">
				<option value="instant-download" id="instant-download">instant-download</option>
				<option value="download-after-button-click-all" id="download-after-button-click-all">
					download after button click all
				</option>
			</select>
		</div>

		<app-root></app-root>

		<script>
			function handleProjectChange(passedValue) {
				var value = document.getElementById("project").value;
				localStorage.setItem("project", passedValue || value);
				if (passedValue) {
					document.getElementById(passedValue).setAttribute("selected", true);
				}
			}
			handleProjectChange(localStorage.getItem("project"));

			function handleEnv(passedValue) {
				var value = document.getElementById("env").value;
				localStorage.setItem("env", passedValue || value);
				if (passedValue) {
					document.getElementById(passedValue).setAttribute("selected", true);
				}
			}
			handleEnv(localStorage.getItem("env"));

			function handleMode(passedValue) {
				var value = document.getElementById("mode").value;
				localStorage.setItem("mode", passedValue || value);
				if (passedValue) {
					document.getElementById(passedValue).setAttribute("selected", true);
				}
			}
			handleMode(localStorage.getItem("mode"));

			/**
			 * Sample JavaScript code for youtube.search.list
			 * See instructions for running APIs Explorer code samples locally:
			 * https://developers.google.com/explorer-help/guides/code_samples#javascript
			 */
			//IMPORTANT:projects can be passed via URL before stringifying the array of them [{name, apiKey}]
			const projects = new URL(window.location.href).searchParams.get("projects");
			if (projects) {
				const parsedProjects = JSON.parse(projects);
				let arrOptions = [];
				parsedProjects.forEach((p) =>
					arrOptions.push(
						"<option value='" + p.name + "' id='" + p.name + "'>" + p.name + "</option>"
					)
				);
				document.getElementById("project").innerHTML = arrOptions.join();
			}
			const project = localStorage.getItem("project");
			gapi.load("client:auth2", function () {
				if (project) {
					handleProjectChange(project);
					gapi.auth2.init({
						client_id: project || "youtube-downloader-310313" //a.popliauskis
					});
				}
			});

			function triggerAutoDownload(passedVideoId) {
				if (document.getElementById(passedVideoId)) {
					document.getElementById(passedVideoId).click();
				}
			}

			// function triggerDownloadAll() {
			// 	console.log("sending post");
			// 	window.postMessage({ shouldStartDownload: true }, "*");
			// }
			window.addEventListener("message", (message) => {
				if (message.data.youtubeVideoId) {
					triggerAutoDownload(message.data.youtubeVideoId);
				}
			});
		</script>
	</body>
</html>
